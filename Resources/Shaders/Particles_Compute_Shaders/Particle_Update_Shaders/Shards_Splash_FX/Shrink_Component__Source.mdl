"

vec2 expected_size = vec2(1.0f, 1.0f);

float shrink_threshold = 0.4f;

void process_shrink()
{
    if(lifetime_ratio() > shrink_threshold)
        return;

    float scale = lifetime_ratio() / shrink_threshold;

    uint coords_offset_index = current_coords_buffer_offset_index();
    if (coords_offset_index >= coords_data.length())
        return;

    vec2 center_position = vec2(0.0f, 0.0f);

    uint coords_per_particle = calculate_coords_per_particle();
    for(uint i = 0; i < coords_per_particle; i += 2)
    {
        center_position.x += coords_data[coords_offset_index + i    ];
        center_position.y += coords_data[coords_offset_index + i + 1];
    }

    center_position /= float(coords_per_particle / 2);

    float width = expected_size.x * scale;
    float height = expected_size.y * scale;

    coords_data[coords_offset_index    ] = width + center_position.x;
    coords_data[coords_offset_index + 1] = height + center_position.y;

    coords_data[coords_offset_index + 2] = -width + center_position.x;
    coords_data[coords_offset_index + 3] = height + center_position.y;

    coords_data[coords_offset_index + 4] = -width + center_position.x;
    coords_data[coords_offset_index + 5] = -height + center_position.y;

    coords_data[coords_offset_index + 6] = width + center_position.x;
    coords_data[coords_offset_index + 7] = height + center_position.y;

    coords_data[coords_offset_index + 8] = -width + center_position.x;
    coords_data[coords_offset_index + 9] = -height + center_position.y;

    coords_data[coords_offset_index + 10] = width + center_position.x;
    coords_data[coords_offset_index + 11] = -height + center_position.y;
}

"
